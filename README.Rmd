---
title: "Analysis of the Effects of Weather on Mortality in Metropolitan Areas"
output: github_document
---

```{r setup, include=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE)
```

Madhu Avula, Nick DeReus, Jacob Johnson, Brianna Norman

# This document will eventually contain the final report of this project. For now it is a place for thoughts and structuring

## Introduction

The weather has outstanding impacts on the daily lives of individuals. It is common knowledge that extreme heat and cold as well as precipitation, wind, and storms can be dangerous. We want to take those into account but also attempt to demonstrate more banal long term effects of seasons and weather.

This project seeks to research the weather’s impact on mortality rates
to better understand the necessity and impact of weather resilience as
well as the potential dangers of ongoing climate change.

We shall endeavor to answer the following questions:

1. Are there seasonal trends in mortality rates? Do different regions experience these impacts differently?
2. How much of an impact does temperature have on mortality? Do different regions experience these impacts differently?
3. Are different age groups affected differently? What age groups are most at risk?
4. Which kinds of weather events have the greatest impacts on mortality? (Extreme heat, cold, ice, flooding)
5. Define which regions are most affected by certain types of weather? (Which most vulnerable to heat waves and extreme cold)
6. Do each of the above trends hold when pnumonia deaths (flu seasons) are removed?

```{R, echo = FALSE} 
allData <- read.csv("Data Files/combined_TAVGxMortality_Data.csv") %>% filter(City != 'Utica')
```

## Data

We had to unite multiple datasets to answer these question, one from the
CDC which contains weekly mortality data for a selection of 122 cities
accessed here:
<https://data.cdc.gov/dataset/Deaths-in-122-U-S-cities-1962-2016-122-Cities-Mort/mr8w-325u/about_data>
. The second dataset, accessed here <https://www.ncdc.noaa.gov/cdo-web/search> contains daily weather summaries from weather
stations from the NOAA, the weather station which best represents
a city from our mortality dataset has to be linked up with their city
and the rest could be dropped.

### Data Values and Structure

#### Deaths in 122 US Cities

- Year -
- WEEK -
- Week Ending Date -
- State -
- City -
- Pneumonia.and.Influenza.Deaths
- All.Deaths -
- \<1 year (all cause deaths) -
- 1-24 years (all cause deaths) -
- 25-44 years (all cause deaths) -
- 45-64 years (all cause deaths) -
- 65+ years (all cause deaths) -

#### NOAA CDO Daily Summaries

This dataset is quite detailed, but we’re mostly interested in three
variables:

1.  TAVG - Average temperature.
2.  TMAX - Maximum Temperature.
3.  TMIN - Minimum Temperature.

- STATION - Identifying weather station code
- NAME - Weather station name
- DATE - Date of summary
- WT03 - Thunder
- WT04 - Ice pellets, sleet, snow pellets, or small hail”
- PRCP - Precipitation
- WT05 - Hail (may include small hail)
- WSFM - Fastest mile wind speed
- WT06 - Glaze or rime
- WT07 - Dust, volcanic ash, blowing dust, blowing sand, or blowing
  obstruction
- WT08 - Smoke or haze
- SNWD - Snow depth
- WT09 - Blowing or drifting snow
- WDF1 - Direction of fastest 1-minute wind
- WDF2 - Direction of fastest 2-minute wind
- WDF5 - Direction of fastest 5-second wind
- WT10 - Tornado, waterspout, or funnel cloud”
- PGTM - Peak gust time
- WT11 - High or damaging winds
- TMAX - Maximum temperature
- WT13 - Mist
- FRGT - Top of frozen ground layer
- WSF2 - Fastest 2-minute wind speed
- FMTM - Time of fastest mile or fastest 1-minute wind
- ACMH - Average cloudiness midnight to midnight from manual
  observations
- WSF5 - Fastest 5-second wind speed
- SNOW - Snowfall
- WDFG - Direction of peak wind gust
- WT14 - Drizzle
- ACSH - Average cloudiness sunrise to sunset from manual observations
- WT15 - Freezing drizzle
- WT16 - Rain (may include freezing rain, drizzle, and freezing
  drizzle)”
- WT17 - Freezing rain
- WT18 - Snow, snow pellets, snow grains, or ice crystals
- WT19 - Unknown source of precipitation
- WSF1 - Fastest 1-minute wind speed
- AWND - Average wind speed
- WT21 - Ground fog
- WSFG - Peak gust wind speed
- WT22 - Ice fog or freezing fog
- WT01 - Fog, ice fog, or freezing fog (may include heavy fog)
- WESD - Water equivalent of snow on the ground
- WT02 - Heavy fog or heaving freezing fog (not always distinguished
  from fog)
- PSUN - Daily percent of possible sunshine for the period
- TAVG - Average Temperature.
- TMIN - Minimum temperature
- WDFM - Fastest mile wind direction
- TSUN - Total sunshine for the period

#### Department of Energy Climate Regions

The US Department of Energy released a map breaking the US into regions at the county level based upon the climate control needs of people in different areas of the nation. Each region is numbered from 1-8, 1 being the hottest and 8 being the coolest. This mapping was selected to help break up the larger dataset by climate region for selection and further comparison.


![alt text](https://github.com/NickDeReus-ISU/DS-202-Final-Project/blob/main/Supporting%20Materials/Climate%20Zones%20Map.jpg)


### Data Preperation

Our multiple datasets had to be combined. Due to constraints with the NOAA data we limited the cities from the 122 in the Mortality dataset to 15 total, 3 from each of the 5 regions from the US Department of Energy map containing the grand majority of the population, regions 2-6.

Region 2
 - Houston, TX
 - Miami, FL
 - Phoenix, AZ
   
Region 3
 - Little Rock, AR
 - Memphis, TN
 - Fresno, CA
   
Region 4
 - Evansville, IN
 - Seattle, WA
 - Wichita, KS
   
Region 5
 - Indianapolis, IN
 - Colorado Springs, CO
 - Boston, MA
   
Region 6
 - Minneapolis, MN
 - Saint Paul, MN
 - Milwaukee, WI
 
These cities then had to be paired up with the weather data, which is tied to specific weather station numbers rather than cities. A table was made up manually containing the information for each city.

| city             | state | station     | region |
|------------------|-------|-------------|--------|
| Houston          | TX    | USW00012918 | 2      |                                                                                        
| Miami            | FL    | USW00012839 | 2      |                                                                                        
| Phoenix          | AZ    | USC00029464 | 2      |
| Little Rock      | AR    | USW00003930 | 3      |                                                                                        
| Memphis          | TN    | USW00013893 | 3      |                                                                                        
| Fresno           | CA    | USW00093193 | 3      |                                                                                        
| Evansville       | IN    | USW00093817 | 4      |                                                                                        
| Seattle          | WA    | USW00024233 | 4      |                                                                                        
| Wichita          | KS    | USW00003928 | 4      |                                                                                        
| Indianapolis     | IN    | USW00093819 | 5      |                                                                                        
| Colorado Springs | CO    | USW00093037 | 5      |                                                                                        
| Boston           | MA    | USW00014739 | 5      |                                                                                        
| Minneapolis      | MN    | USW00014922 | 6      |                                                                                        
| Saint Paul       | MN    | USW00014922 | 6      |                                                                                        
| Milwaukee        | WI    | USW00014839 | 6      |                                                                                        

With that prepared, we clean our data:
```
# Imports:
mortality <- read_csv("Deaths_in_122_U.S._cities_-_1962-2016._122_Cities_Mortality_Reporting_System_20241019.csv")
all_station_weather <- read_csv("Station_weather_data.csv")
City_station_numbers <- read_csv("City_station_numbers.csv")

# Clean the table containing the manually entered city station data which contained empty rows
City_station_numbers <- City_station_numbers %>% drop_na(city)

# Rename columns in the weather dataframe
all_station_weather <- all_station_weather %>% rename_at('city', ~'City')
all_station_weather <- all_station_weather %>% rename_at('state', ~'State')

```
Prepare and aggregate weather data, the weather data is daily while the mortality data is weekly.

```
# Expand Date Data
weather_data_prepped <- all_station_weather2 %>% 
 
  mutate( 
    DATE = mdy(DATE),
    Week = week(DATE),
    Month = month(DATE),
    Year = year(DATE),
) %>% 
  
  group_by(STATION, Year, Week)

# Select Values to be Aggregated
TAVG_weekly <- weather_data_prepped %>% 
  
  group_by(region, State, City, STATION, Year, Month, Week) %>%
  
  summarize(
    TAVG = mean(TAVG),
    TMAX_Max = max(TMAX),
    TMAX_Mean = mean(TMAX),
    TMIN_Min = min(TMIN),
    TMIN_Mean = mean(TMIN),
    TSUN = mean(TSUN),
    WSFG_Max = max(WSFG),
    WSFG_Mean = mean(WSFG),
    AWND = mean(AWND),
    PRCP_Mean = mean(PRCP),
    PRCP_Sum = sum(PRCP),
    PRCP_Max = max(PRCP),
    SNOW_Mean = mean(SNOW),
    SNOW_Sum = sum(SNOW),
    SNWD_Mean = mean(SNWD),
    SNWD_Max = mean(SNWD),
  )
```
We then filter and combine our dataframes

```
# Filter the mortality in 122 cities data by city 
mortality_small <- mortality %>% filter(City %in% City_station_numbers$city)

# Merge all_station_weather with city_station_data, adding city and region information to the weather data.
all_station_weather2 <- merge(all_station_weather, mutate(City_station_numbers, STATION = station), by = 'STATION')

# Mutate mortality data, renaming region and adding detailed date information we can use to filter.
mortality_small <- mortality_small %>% mutate(
  Date = mdy(`Week Ending Date`),
  Week = week(Date),
  Month = month(Date),
  Year = year(Date),
) %>% rename_at('REGION', ~'CDC_Region')
```
Finally combine weather and mortality data

```
wm_combined <- merge(mortality_small, TAVG_weekly)
```

### Final Data Shape

## Results

### Basic Observations of from the Dataset

#### Average Annual Temperature Over Time

We find that the locations in our dataset have seen a progressive increase in average temperatures over the time since the beginning of the time period in 1962. We can't use this to prove global warming necessarily because these locations are all likely subject to the Heat Island effect, but the experience of people living in these locations is one of increasing average temperature.

```{r}
allData %>% filter(!is.na(`TAVG`)) %>% group_by(Year) %>% summarize(
  Avg = mean(`TAVG`)
) %>%
  ggplot(aes(x = Year, y = Avg, color = Year) ) + geom_line() + ggtitle('Annual Average Temperature') + scale_color_gradient(low = "pink", high = "darkred" ) + ylab("Average Temperature") + theme(legend.position = "none")
```

When charted by region, we can see that this increase in average temperatures is felt across all climate regions, but is most obvious in Region 6, which is the coolest region.

```{r}
allData %>% filter(!is.na(`TAVG`)) %>% group_by(region, Year) %>% summarize(
  Avg = mean(`TAVG`)
) %>%
  ggplot(aes(x = Year, y = Avg, color = factor(region)) ) + geom_line() + ggtitle('Annual Average Temperature by Region') + ylab("Average Temperature")
```


#### Seasonality of Temperature

```{r}
allData %>% filter(!is.na(`TAVG`)) %>% group_by(Month) %>% summarize(
  Avg = mean(`TAVG`)
) %>%
  ggplot(aes(x = Month %>% factor(), y = Avg, fill = Avg)) + geom_bar(stat = 'identity') + ggtitle('Average Temperature by Month') + scale_fill_gradient(low = "pink", high = "darkred" ) + ylab("Average Temperature") + xlab("Month") + theme(legend.position = "none")
```

```{r}
allData %>% filter(!is.na(`TAVG`)) %>% group_by(region, Month) %>% summarize(
  Avg = mean(`TAVG`)
) %>%
  ggplot(aes(x = Month %>% factor(), y = Avg, fill = Avg)) + geom_bar(stat = 'identity') + facet_wrap('region') + ggtitle('Average Temperature by Month') + scale_fill_gradient(low = "pink", high = "darkred" ) + ylab("Average Temperature") + xlab("Month") + theme(legend.position = "none")
```

#### Distribution of Daily Average Temperatures

```{r}
allData %>% filter(!is.na(`TAVG`)) %>% group_by(region) %>% ggplot(aes(x = TAVG, )) + geom_histogram(binwidth = 5, fill = 'darkred', color = 'black') + ggtitle('Average Temperature Histogram') + ylab("Count") + xlab("Average Temperature (F)") + theme(legend.position = "none") 
```

### Seasonal trends in mortality rates

After normalizing death counts across our regions we find that death rates across our sample set are significantly higher on avg during the winter season and lower in summer months.

```{r}
# Normalize Deaths
dfStats <- allData %>% group_by(City) %>% filter(!is.na(All.Deaths)) %>% summarize(
  All_Deaths_mm = mean(All.Deaths),
  All_Deaths_msd = sd(All.Deaths),
)

df2 <- merge(allData, dfStats)

df2 %>% group_by(City, Month) %>% 
  reframe(
    deathsZ = (`All.Deaths` - All_Deaths_mm) / All_Deaths_mm
  ) %>% filter(!is.na(deathsZ)) %>% group_by(Month) %>% reframe(
    deathsZ = mean(deathsZ)
  ) %>%
  ggplot(aes( x = as.factor(Month),
             y = deathsZ,
             fill = deathsZ,
             ) 
         ) + 
  geom_bar(stat = 'identity',) + ylab("% difference from mean deaths") + xlab("Month") + scale_fill_gradient(low = "pink", high = "darkred" ) + theme(legend.position = "none")
```



```{R}
### Create lists of the cities that I'm making observations on
myStatesList <- c('FL', 'CA', 'KS', 'CO')
myCitiesList <- c('Miami', 'Fresno', 'Wichita', 'Colorado Springs')
```

When we break down the data regionally we can see that colder regions have more highly seasonal effects on mortality, but even very warm regions suffer higher mortality in the winter months.

We hypothesize that there are behavioral factors behind the increased winter mortality, but we aren't able to explore that here. At the very least we can assume that weather cannot be the only, or even the most major, factor behind these findings.

```{R}
### Filter data down to focused cities
### Deaths seem to be higher on average in the Winter Months
### Fresno in Region 3, specifically, saw jumps in mortality November through March each year
### Miami, in Region 2, reported a jump in mortality count between June and July in years 
# myCitiesData <- allData %>%
#   filter(State %in% myStatesList) %>% filter(City %in% myCitiesList)
# 
# monthlyDeathsSummed<- myCitiesData %>%
#   group_by(Month, Year, City) %>%
#   summarise(total = sum(All.Deaths))
# 
# ggplot(monthlyDeathsSummed, aes(x=Month, y=total, color=City)) + 
#   geom_point() + 
#   facet_wrap(~Year, scales="free_x") +
#   labs(
#     title = "Total Deaths by Month",
#     x = "Month",
#     y = "Total Deaths"
#   )

df2 %>% group_by(region, City, Month) %>% 
  reframe(
    deathsZ = (`All.Deaths` - All_Deaths_mm) / All_Deaths_mm
  ) %>% filter(!is.na(deathsZ)) %>% group_by(region, Month) %>% reframe(
    deathsZ = mean(deathsZ)
  ) %>%
  ggplot(aes( x = as.factor(Month),
             y = deathsZ,
             fill = deathsZ,
             ) 
         ) + 
  geom_bar(stat = 'identity',) + ylab("% difference from mean deaths") + xlab("Month") + scale_fill_gradient(low = "pink", high = "darkred" ) + facet_wrap(~region) + theme(legend.position = "none")
```

### Correlation between temperature and Mortality 

```{R}
ourStatesList <- c('FL', 'CA', 'KS', 'CO', 'TX', 'TN', 'WA', 'IN', 'AZ', 'AR', 'IN', 'MA', 'MN', 'WI')
ourCitiesList <- c('Miami', 'Fresno', 'Wichita', 'Colorado Springs', 'Pheonix', 'Little Rock', 'Evansville', 'Boston', 'Houston', 'Memphis', 'Seattle', 'Indianapolis', 'Minneapolis', 'Saint Paul', 'Milwaukee')

ourCitiesData <- allData %>%
  filter(State %in% ourStatesList) %>% filter(City %in% ourCitiesList)
```
#### The most deaths occurred during times where the average minimum temperature was between 45 and 60, which is likely the minimum from the days with high maximum temperatures. It is expected that colder regions will see higher mortality counts in lower temperatures when observed outside of the other regions.
#### Plot of the mean of the minimum monthly temperature plotted against the total deaths occurring at those temperatures
```{R}
ggplot(ourCitiesData, aes(x=TMIN_Mean, weight=All.Deaths)) + geom_histogram(bins=15)
```
Region 2 sees the highest death counts at maximum temperatures near 90, with death counts sharply increasing as the max temperature approaches that value. This region's mortality rates do not seem as affected by temperatures below 35, likely due to a generally higher climate and not seeing temperatures that low.
Region 6 confirms the earlier held suspicion of a colder climate holding a higher mortality rate at lower temperatures than that of higher climates. This region has two mortality rate spikes: One where the max temperature approaches 75, and another where it is close to 30. However, the mortality rate seems to be fairly consistent at minimum temperatures between 35 and 60 in region 6


```{R}
ggplot(ourCitiesData, aes(x=TMAX_Mean, weight=All.Deaths)) + geom_histogram(bins=15) + facet_wrap(~region)
```
  Plot of the mean of the maximum monthly temperature plotted against the total deaths occurring at those temperatures, grouped by Region

```{R}
ggplot(ourCitiesData, aes(x=TMIN_Mean, weight=All.Deaths)) + geom_histogram(bins=15) + facet_wrap(~region)
```
  Plot of the mean of the minimum monthly temperature plotted against the total deaths occurring at those temperatures
  
  
### Differences in effects by age group
- **Key Findings**:
  - The **65+ years** age group accounts for the highest percentage of total deaths, contributing over 60% of mortality.
  - The **45–64 years** age group is the second most affected, with a significant but smaller share.
  - Younger age groups, including **<1 year**, **1–24 years**, and **25–44 years**, have considerably lower mortality percentages.
- **Conclusion**:
  - Older adults (**65+ years**) are the most vulnerable group, indicating a need for targeted health interventions.
  - The **45–64 years** group also requires attention, but with lower priority compared to seniors.
  
```{r}
# Summarize total deaths by age group
age_groups <- c("X.1.year..all.cause.deaths.", "X1.24.years..all.cause.deaths.",
                "X25.44.years", "X45.64.years..all.cause.deaths.", "X65..years..all.cause.deaths.")
total_deaths <- colSums(allData[, age_groups], na.rm = TRUE)

# Calculate percentages
percent_deaths <- total_deaths / sum(total_deaths) * 100

# Plot the data
barplot(percent_deaths, names.arg = c("<1 year", "1-24 years", "25-44 years", "45-64 years", "65+ years"),
        main = "Mortality Distribution by Age Group", ylab = "Percentage of Total Deaths", col = "darkred")
```

### Effects of Seasonality by Age Group

### Key Findings
- **WT01 (Fog, ice fog, or freezing fog)** and **WT16 (Rain, including freezing rain)** have the highest associated mortality, exceeding 1.4 × 10^8 deaths each.
- Other weather events with notable impacts include:
  - **WT08 (Smoke or haze)**
  - **WT03 (Thunder)**
  - **WT13 (Mist)**
  - **WT18 (Snow, snow pellets, or ice crystals)**
- Events like **WT10 (Tornado, waterspout, or funnel cloud)** and **WT22 (Ice fog)** have minimal impacts on mortality.

### Conclusion
- **Fog and rain-related events** pose the greatest risks to mortality, likely due to reduced visibility, accidents, or secondary health impacts.
- **Smoke/haze and snow events** also contribute significantly, highlighting their environmental and safety hazards.

```{r}
# Summarize total deaths by age group
age_groups <- c("X.1.year..all.cause.deaths.", "X1.24.years..all.cause.deaths.",
                "X25.44.years", "X45.64.years..all.cause.deaths.", "X65..years..all.cause.deaths.")

allData %>% filter(!is.na(`All.Deaths`)) %>% group_by(City, Month) %>% pivot_longer(
  cols = age_groups,
  names_to = 'Age_Group',
  values_to = 'deaths',
) %>% filter(!is.na(deaths) ) %>% group_by(City, Age_Group) %>% mutate(
   deaths_sd = sd(deaths),
   deaths_mean = mean(deaths),
   deathsZ = (deaths - deaths_mean) / deaths_mean,
) %>% filter(!is.na(deaths) ) %>% group_by(Month, Age_Group) %>%
  mutate(
    deathsZ = mean(deathsZ)
  ) %>% filter(!is.na(deathsZ) ) %>%  
  ggplot(aes(x = factor(Month), y = deathsZ, fill = Age_Group )) + geom_bar(stat = 'identity', position = 'dodge') + labs(title = "Seasonal Mortality Anomaly by Age Group", y = "Deaths as % of mean", x = 'Month', fill = "Age Group") + scale_fill_discrete(labels = c("<1 year (all cause deaths)", "1-24 years (all cause deaths)",
                "25-44 years", "45-64 years (all cause deaths)", "65+ years (all cause deaths)"))
```


### The effect of various weather events on mortality
#### Regional Effects

### Relative Vulnerability to Weather Events by Region

**Specific question #5:** Define which regions are most affected by certain types of weather? (Which most vulnerable to heat waves and extreme cold)

```{r}
# Define thresholds for heat waves and extreme cold
heat_wave_threshold <- 90  # Threshold for heat wave (in degrees Fahrenheit)
extreme_cold_threshold <- 15  # Threshold for extreme cold (in degrees Fahrenheit)

# Filter data for heat waves, extreme cold, normal conditions(temperatures between the thresholds)
heat_wave_data <- data_main %>%
  filter(TMAX_Max >= heat_wave_threshold)

extreme_cold_data <- data_main %>%
  filter(TMIN_Min <= extreme_cold_threshold)

normal_data <- data_main %>%
  filter(TMAX_Max < heat_wave_threshold & TMIN_Min > extreme_cold_threshold)


# Calculate average and total deaths during heat waves by week
heat_wave_deaths <- heat_wave_data %>%
  group_by(region) %>%
  summarise(
    avg_deaths = mean(All.Deaths, na.rm = TRUE),
    total_deaths = sum(All.Deaths, na.rm = TRUE)) %>% 
  arrange(desc(total_deaths))

# Calculate average and total deaths during extreme cold by week
extreme_cold_deaths <- extreme_cold_data %>%
  group_by(region) %>%
  summarise(
    avg_deaths = mean(All.Deaths, na.rm = TRUE),
    total_deaths = sum(All.Deaths, na.rm = TRUE)) %>% 
  arrange(desc(total_deaths))
```


**Deaths during Heat Wave/Extreme Cold/General Conditions**
```{r}
# custom colors for each region
custom_colors <- c(
  "1" = "#1f77b4",
  "2" = "#ff7f0e",
  "3" = "#2ca02c",
  "4" = "#d62728",
  "5" = "#9467bd",  
  "6" = "#8c564b"   
)


# Summarize data by week and region (general)
data_summary <- data_main %>%
  group_by(region, Week) %>%
  summarise(All.Deaths = sum(All.Deaths, na.rm = TRUE))

# Plot multiple lines based on region with custom colors
ggplot(data_summary, aes(x = Week, y = All.Deaths, color = as.factor(region), group = region)) +
  geom_line(size = 1) +
  scale_color_manual(values = custom_colors) +
  theme_minimal() +
  labs(title = "All Deaths by Week and Region (General Conditions)",
       x = "Week",
       y = "All.Deaths",
       color = "Region")

#--------------------------------------------------
  
# Summarize data by week and region (heat wave)
data_summary_heat_wave <- heat_wave_data %>%
  group_by(region, Week) %>%
  summarise(All.Deaths = sum(All.Deaths, na.rm = TRUE))

# Plot multiple lines based on region with custom colors
ggplot(data_summary_heat_wave, aes(x = Week, y = All.Deaths, color = as.factor(region), group = region)) +
  geom_line(size = 1) +
  scale_color_manual(values = custom_colors) +
  theme_minimal() +
  labs(title = "All Deaths by Week and Region (During Heat Waves)",
       x = "Week",
       y = "All.Deaths",
       color = "Region")

#--------------------------------------------------

# Summarize data by week and region (extreme cold)
data_summary_extreme_cold <- extreme_cold_data %>%
  group_by(region, Week) %>%
  summarise(All.Deaths = sum(All.Deaths, na.rm = TRUE))

# Plot multiple lines based on region with custom colors
ggplot(data_summary_extreme_cold, aes(x = Week, y = All.Deaths, color = as.factor(region), group = region)) +
  geom_line(size = 1) +
  scale_color_manual(values = custom_colors) +
  theme_minimal() +
  labs(title = "All Deaths by Week and Region (During extreme cold)",
       x = "Week",
       y = "All.Deaths",
       color = "Region")
```

**Difference between mortality during heat waves/freezes compared to normal**
```{r}
# Calculate average mortality during normal conditions
normal_mortality <- normal_data %>%
  summarise(avg_deaths = mean(All.Deaths, na.rm = TRUE))

# Calculate average mortality during heat waves
heat_wave_mortality <- heat_wave_data %>%
  summarise(avg_deaths = mean(All.Deaths, na.rm = TRUE))

# Calculate average mortality during extreme cold
extreme_cold_mortality <- extreme_cold_data %>%
  summarise(avg_deaths = mean(All.Deaths, na.rm = TRUE))

# Calculate differences in mortality rates
mortality_diff <- data.frame(
  Condition = c("Normal", "Heat Wave", "Extreme Cold"),
  Avg_Deaths = c(normal_mortality$avg_deaths, heat_wave_mortality$avg_deaths, extreme_cold_mortality$avg_deaths)
)

mortality_diff <- mortality_diff %>%
  mutate(Difference = Avg_Deaths / normal_mortality$avg_deaths)

mortality_diff

# Visualizing the differences in mortality rates
ggplot(mortality_diff, aes(x = Condition, y = Difference, fill = Condition)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Difference in Mortality Rates During Extreme Weather Conditions",
       x = "Condition",
       y = "Difference in Average Deaths",
       fill = "Condition")
```


```{r}
# Calculate average mortality during normal conditions, grouped by city
normal_mortality <- normal_data %>%
  group_by(City) %>%
  summarise(avg_deaths_normal = mean(All.Deaths, na.rm = TRUE))

# Calculate average mortality during heat waves, grouped by city
heat_wave_mortality <- heat_wave_data %>%
  group_by(City) %>%
  summarise(avg_deaths_heat_wave = mean(All.Deaths, na.rm = TRUE))

# Calculate average mortality during extreme cold, grouped by city
extreme_cold_mortality <- extreme_cold_data %>%
  group_by(City) %>%
  summarise(avg_deaths_extreme_cold = mean(All.Deaths, na.rm = TRUE))

# Combining the Mortality Rates data into one data frame
mortality_diff <- normal_mortality %>%
  left_join(heat_wave_mortality, by = "City") %>%
  left_join(extreme_cold_mortality, by = "City") %>%
  mutate(
    heat_wave_diff = (avg_deaths_heat_wave / avg_deaths_normal),
    extreme_cold_diff = (avg_deaths_extreme_cold / avg_deaths_normal))

mortality_diff

# Visualizing the Results + Reshape the data for plotting
mortality_diff_long <- mortality_diff %>%
  pivot_longer(cols = c(heat_wave_diff, extreme_cold_diff), names_to = "Condition", values_to = "Difference")

# Plot the differences in mortality rates by city
ggplot(mortality_diff_long, aes(x = City, y = Difference, fill = Condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Percentage difference in Mortality Rates During Extreme Weather 
       Conditions by City",
       x = "City",
       y = "Percentage difference in Average Deaths",
       fill = "Condition") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

- **Key Findings**:
  - In total **Normal** and **Heat wave** average deaths are very similar **0.0017%** difference
  - In total **Extreme cold** average deaths is lower by around **22%** difference
  - The cities **Fresno, CA** & **Miami, FL** have no extreme cold deaths
  - **Colorado Springs** experiences a slight increase in average deaths during heat waves compared to normal conditions.
  - **Houston** sees a significant increase in average deaths during extreme cold conditions compared to normal conditions.

- **Conclusion for #5**:
  - Region 2 (Cities - Houston, Miami, and Phoenix) has an average difference 
    factor of **129%** increase in average deaths during extreme cold conditions 
    compared to normal conditions.
  - Region 5 (Cities - Indianapolis, Colorado Springs, and Boston) has an average
    difference factor of **97%** decrease in average deaths during heat waves 
    compared to normal conditions. 
    
### Controlling for Flu season

**Specific question #6:** Do each of the above trends hold when pneumonia deaths (flu seasons) are removed?


```{r}
# Group by month and calculate the total pneumonia deaths
data_main %>%
  group_by(Month) %>%
  summarise(Total_Pneumonia_Deaths = sum(Pneumonia.and.Influenza.Deaths, na.rm = TRUE)) %>% 
  ggplot(aes(x = factor(Month), y = Total_Pneumonia_Deaths)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  theme_minimal() +
  labs(title = "Total Pneumonia Deaths by Month",
       x = "Month",
       y = "Total Pneumonia Deaths") +
  scale_x_discrete(labels = month.abb)  # Use abbreviated month names```

# Group by month and calculate the total deaths
data_main %>%
  group_by(Month) %>%
  summarise(Total_Deaths = sum(All.Deaths, na.rm = TRUE)) %>% 
  ggplot(aes(x = factor(Month), y = Total_Deaths)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  theme_minimal() +
  labs(title = "Total Deaths by Month",
       x = "Month",
       y = "Total Deaths") +
  scale_x_discrete(labels = month.abb)  # Use abbreviated month names```
```

```{r}
# Summarize total deaths by age group
age_groups <- c("X.1.year..all.cause.deaths.", "X1.24.years..all.cause.deaths.",
                "X25.44.years", "X45.64.years..all.cause.deaths.", "X65..years..all.cause.deaths.")

data_main %>% filter(!is.na(`All.Deaths`)) %>% group_by(City, Month) %>% pivot_longer(
  cols = age_groups,
  names_to = 'Age_Group',
  values_to = 'deaths',
) %>% filter(!is.na(deaths) ) %>% group_by(City, Age_Group) %>% mutate(
   deaths_sd = sd(deaths),
   deaths_mean = mean(deaths),
   deathsZ = (deaths - deaths_mean) / deaths_mean,
) %>% filter(!is.na(deaths) ) %>% group_by(Month, Age_Group) %>%
  mutate(
    deathsZ = mean(deathsZ)
  ) %>% filter(!is.na(deathsZ) ) %>%  
  ggplot(aes(x = factor(Month), y = deathsZ, fill = Age_Group )) + geom_bar(stat = 'identity', position = 'dodge') + labs(title = "Seasonal Mortality Anomaly by Age Group", y = "Deaths as % of mean", x = 'Month', fill = "Age Group") + scale_fill_discrete(labels = c("<1 year (all cause deaths)", "1-24 years (all cause deaths)",
                "25-44 years", "45-64 years (all cause deaths)", "65+ years (all cause deaths)"))


# Subtract Pneumonia.and.Influenza.Deaths from All.Deaths
data_main_excluding_pneumonia <- data_main %>%
  mutate(All.Deaths = All.Deaths - Pneumonia.and.Influenza.Deaths)

data_main_excluding_pneumonia %>% filter(!is.na(`All.Deaths`)) %>% group_by(City, Month) %>% pivot_longer(
  cols = age_groups,
  names_to = 'Age_Group',
  values_to = 'deaths',
) %>% filter(!is.na(deaths) ) %>% group_by(City, Age_Group) %>% mutate(
   deaths_sd = sd(deaths),
   deaths_mean = mean(deaths),
   deathsZ = (deaths - deaths_mean) / deaths_mean,
) %>% filter(!is.na(deaths) ) %>% group_by(Month, Age_Group) %>%
  mutate(
    deathsZ = mean(deathsZ)
  ) %>% filter(!is.na(deathsZ) ) %>%  
  ggplot(aes(x = factor(Month), y = deathsZ, fill = Age_Group )) + 
  geom_bar(stat = 'identity', position = 'dodge') + 
  labs(title = "Seasonal Mortality Anomaly by Age Group (Excluding Pneumonia and Influenza Deaths)",
       y = "Deaths as % of mean", x = 'Month',
       fill = "Age Group") + 
  scale_fill_discrete(labels = c("<1 year (all cause deaths)",
                                 "1-24 years (all cause deaths)",
                                 "25-44 years", "45-64 years (all cause deaths)",
                                 "65+ years (all cause deaths)"))
```

- **Key Findings**:
  - The total number of deaths ranges from **400,000-350,000** deaths a month
  - The total number of pneumonia & influenza deaths range from **30,000-16,000**
  - Using the seasonal mortality by age group chart compared to the same chart 
    excluding pneumonia & influenza deaths is little to no difference.

- **Conclusion for #6**:
  - The amount of pneumonia & influenza deaths varies between age groups but the
    overall variation between the two charts is minimal and still shows that same
    trends in the data as before.

## Conclusion

## References
"Deaths in 122 US Cities, 1962-2016", CDC, <https://data.cdc.gov/dataset/Deaths-in-122-U-S-cities-1962-2016-122-Cities-Mort/mr8w-325u/about_data>

Weather station daily summaries, NOAA, <https://www.ncdc.noaa.gov/cdo-web/search>